.model small
.stack 100h
.data
fname       db "records.txt", 0
fhand       dw ?
filebuf     db 32 dup(' ')

sortbuf     db 3200 dup(?)
numrecs     dw 0

insr        db 3, ?, 3 dup(' ')
inname      db 11, ?, 11 dup(' ')
infam       db 3, ?, 3 dup(' ')
inwat       db 4, ?, 4 dup(' ')
inflr       db 4, ?, 4 dup(' ')
inpls       db 4, ?, 4 dup(' ')

upid        db 3, ?, 3 dup(' ')

menumsg     db 0dh, 0ah, "--- MENU ---"
            db 0dh, 0ah, "1. Add Record"
            db 0dh, 0ah, "2. View Records"
            db 0dh, 0ah, "3. Show Totals"
            db 0dh, 0ah, "4. Sort by ID"
            db 0dh, 0ah, "5. Delete Record"
            db 0dh, 0ah, "6. Update Record"
            db 0dh, 0ah, "7. Exit"
            db 0dh, 0ah, "Select: $"

txtsr       db 0dh, 0ah, "Sr# (2 digits): $"
txtname     db 0dh, 0ah, "Name (10 chars): $"
txtfam      db 0dh, 0ah, "Family Count: $"
txtwat      db 0dh, 0ah, "Water Liter: $"
txtflr      db 0dh, 0ah, "Flour Kg: $"
txtpls      db 0dh, 0ah, "Pulses Kg: $"

txtupdid    db 0dh, 0ah, "Enter ID to Update: $"
txtdelid    db 0dh, 0ah, "Enter ID to Delete: $"
msgsave     db 0dh, 0ah, "Saved.$"
msgsort     db 0dh, 0ah, "File Sorted by ID.$"
msgupd      db 0dh, 0ah, "Record Updated.$"
msgdel      db 0dh, 0ah, "Record Deleted.$"
msgtot      db 0dh, 0ah, "Total Family: $"
msgno       db 0dh, 0ah, "ID Not Found.$"
newline     db 0dh, 0ah, "$"

totfam      dw 0

.code
main proc
mov ax, @data
mov ds, ax

mov ah, 3dh
mov al, 0
lea dx, fname
int 21h
jnc fileok

mov ah, 3ch
mov cx, 0
lea dx, fname
int 21h

fileok:
mov bx, ax
mov ah, 3eh
int 21h

startmenu:
lea dx, menumsg
mov ah, 09h
int 21h

mov ah, 01h
int 21h

cmp al, '1'
je  doadd
cmp al, '2'
je  doview
cmp al, '3'
je  dototals
cmp al, '4'
je  dosort
cmp al, '5'
je  dodelete
cmp al, '6'
je  doupdate
cmp al, '7'
je  doexit
jmp startmenu

doadd:
call lblgetinput
call lblformatbuf
    
mov ah, 3dh
mov al, 1
lea dx, fname
int 21h
mov fhand, ax

mov ah, 42h
mov al, 2
mov bx, fhand
xor cx, cx
xor dx, dx
int 21h

mov ah, 40h
mov bx, fhand
mov cx, 32
lea dx, filebuf
int 21h

mov ah, 3eh
mov bx, fhand
int 21h

lea dx, msgsave
mov ah, 09h
int 21h
jmp startmenu

doview:
lea dx, newline
mov ah, 09h
int 21h

mov ah, 3dh
mov al, 0
lea dx, fname
int 21h
mov fhand, ax

readloop:
mov ah, 3fh
mov bx, fhand
mov cx, 32
lea dx, filebuf
int 21h

cmp ax, 32
jne viewdone

mov cx, 32
mov si, 0
printloop:
mov dl, filebuf[si]
mov ah, 02h
int 21h
inc si
loop printloop

jmp readloop

viewdone:
mov ah, 3eh
mov bx, fhand
int 21h
jmp startmenu

dototals:
mov totfam, 0

mov ah, 3dh
mov al, 0
lea dx, fname
int 21h
mov fhand, ax

calcloop:
mov ah, 3fh
mov bx, fhand
mov cx, 32
lea dx, filebuf
int 21h

cmp ax, 32
jne showtot

xor cx, cx
    
mov al, filebuf[15]
cmp al, ' '
je checkd2
sub al, 30h
mov cl, al

checkd2:
mov al, filebuf[16]
cmp al, ' '
je addtot
sub al, 30h

push ax
mov al, cl
mov bl, 10
mul bl
mov cl, al
pop ax

add cl, al

addtot:
xor ch, ch
add totfam, cx
jmp calcloop

showtot:
mov ah, 3eh
mov bx, fhand
int 21h

lea dx, msgtot
mov ah, 09h
int 21h

mov ax, totfam
mov bl, 10
div bl
mov bx, ax

mov dl, bl
add dl, 30h
mov ah, 02h
int 21h

mov dl, bh
add dl, 30h
mov ah, 02h
int 21h

jmp startmenu

dosort:
call lblloadfile
cmp numrecs, 1
jle savesort

mov cx, numrecs
dec cx

outsort:
push cx
mov si, 0

insort:
mov al, sortbuf[si]
cmp al, sortbuf[si+32]
jg  swaprec
jl  nextrec

mov al, sortbuf[si+1]
cmp al, sortbuf[si+33]
jg  swaprec

jmp nextrec

swaprec:
mov bx, 0
swapbyte:
mov al, sortbuf[si+bx]
mov dl, sortbuf[si+bx+32]
mov sortbuf[si+bx], dl
mov sortbuf[si+bx+32], al
inc bx
cmp bx, 32
jne swapbyte

nextrec:
add si, 32
loop insort

pop cx
loop outsort

savesort:
call lblsavefile
lea dx, msgsort
mov ah, 09h
int 21h
jmp startmenu

dodelete:
lea dx, txtdelid
mov ah, 09h
int 21h
lea dx, upid
mov ah, 0ah
int 21h

call lblloadfile
cmp numrecs, 0
je startmenu

mov si, 0
mov cx, numrecs
mov dx, 0

delsearch:
mov al, upid[2]
cmp al, sortbuf[si]
jne delnext
    
mov al, upid[3]
cmp al, sortbuf[si+1]
jne delnext

mov sortbuf[si], 0
mov dx, 1
jmp delrewrite

delnext:
add si, 32
loop delsearch

delrewrite:
cmp dx, 1
jne notfounddel

mov ah, 3ch
mov cx, 0
lea dx, fname
int 21h
mov fhand, ax

mov si, 0
mov cx, numrecs

delwrite:
cmp sortbuf[si], 0
je skipwrite

push cx
mov ah, 40h
mov bx, fhand
mov cx, 32
lea dx, sortbuf[si]
int 21h
pop cx

skipwrite:
add si, 32
loop delwrite

mov ah, 3eh
mov bx, fhand
int 21h

lea dx, msgdel
mov ah, 09h
int 21h
jmp startmenu

notfounddel:
lea dx, msgno
mov ah, 09h
int 21h
jmp startmenu

doupdate:
lea dx, txtupdid
mov ah, 09h
int 21h
lea dx, upid
mov ah, 0ah
int 21h

call lblloadfile
cmp numrecs, 0
je startmenu

mov si, 0
mov cx, numrecs

updsearch:
mov al, upid[2]
cmp al, sortbuf[si]
jne updnext

mov al, upid[3]
cmp al, sortbuf[si+1]
jne updnext

push si
    
lea dx, newline
mov ah, 09h
int 21h
call lblgetinput
call lblformatbuf

pop si

mov di, si
mov bx, 0
copynew:
mov al, filebuf[bx]
mov sortbuf[di], al
inc bx
inc di
cmp bx, 32
jne copynew

call lblsavefile
    
lea dx, msgupd
mov ah, 09h
int 21h
jmp startmenu

updnext:
add si, 32
loop updsearch

lea dx, msgno
mov ah, 09h
int 21h
jmp startmenu

doexit:
mov ah, 4ch
mov al, 00h
int 21h

lblgetinput:
lea dx, txtsr
mov ah, 09h
int 21h
lea dx, insr
mov ah, 0ah
int 21h

lea dx, txtname
mov ah, 09h
int 21h
lea dx, inname
mov ah, 0ah
int 21h

lea dx, txtfam
mov ah, 09h
int 21h
lea dx, infam
mov ah, 0ah
int 21h

lea dx, txtwat
mov ah, 09h
int 21h
lea dx, inwat
mov ah, 0ah
int 21h

lea dx, txtflr
mov ah, 09h
int 21h
lea dx, inflr
mov ah, 0ah
int 21h

lea dx, txtpls
mov ah, 09h
int 21h
lea dx, inpls
mov ah, 0ah
int 21h
ret

lblformatbuf:
mov cx, 32
mov si, 0
clrbuf:
mov filebuf[si], ' '
inc si
loop clrbuf

mov cl, insr[1]
cmp cl, 0
je skipsr
mov ch, 0
mov si, 0
copsr:
mov al, insr[si+2]
mov filebuf[si+0], al
inc si
loop copsr
skipsr:

mov cl, inname[1]
cmp cl, 0
je skipnm
mov ch, 0
mov si, 0
copnm:
mov al, inname[si+2]
mov filebuf[si+4], al
inc si
loop copnm
skipnm:

mov cl, infam[1]
cmp cl, 0
je skipfm
mov ch, 0
mov si, 0
copfm:
mov al, infam[si+2]
mov filebuf[si+15], al
inc si
loop copfm
skipfm:

mov cl, inwat[1]
cmp cl, 0
je skipwt
mov ch, 0
mov si, 0
copwt:
mov al, inwat[si+2]
mov filebuf[si+18], al
inc si
loop copwt
skipwt:

mov cl, inflr[1]
cmp cl, 0
je skipfl
mov ch, 0
mov si, 0
copfl:
mov al, inflr[si+2]
mov filebuf[si+22], al
inc si
loop copfl
skipfl:

mov cl, inpls[1]
cmp cl, 0
je skippl
mov ch, 0
mov si, 0
coppl:
mov al, inpls[si+2]
mov filebuf[si+26], al
inc si
loop coppl
skippl:

mov filebuf[30], 0dh
mov filebuf[31], 0ah
ret

lblloadfile:
mov ah, 3dh
mov al, 0
lea dx, fname
int 21h
mov fhand, ax

mov ah, 3fh
mov bx, fhand
mov cx, 3200
lea dx, sortbuf
int 21h

mov bl, 32
div bl
mov ah, 0
mov numrecs, ax

mov ah, 3eh
mov bx, fhand
int 21h
ret

lblsavefile:
mov ah, 3ch
mov cx, 0
lea dx, fname
int 21h
mov fhand, ax

mov ax, numrecs
mov bx, 32
mul bx
mov cx, ax

mov ah, 40h
mov bx, fhand
lea dx, sortbuf
int 21h

mov ah, 3eh
mov bx, fhand
int 21h
ret

main endp
end main
